<form class="sw5e-helper-damage">

  {{!-- ================= Header ================= --}}
  <header class="hdr">
    <h2>{{localize "SW5EHELPER.DamageTitle"}}</h2>
  </header>

  {{!-- ============ Quick Row ============ --}}
  <section class="row quick">
    <button type="button" class="btn" data-action="load-last">
      {{localize "SW5EHELPER.LoadLast"}}
    </button>
  </section>

  {{!-- =========== Weapon Selection Row ========== --}}
  <section class="row weapon">
    <label for="weaponId">{{localize "SW5EHELPER.Weapon"}}</label>
    <select name="weaponId" id="weaponId" {{#if weaponLocked}}disabled{{/if}}>
      {{#each weapons}}
        <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.name}}</option>
      {{/each}}
    </select>
    {{#if weaponLocked}}
      <span class="note" style="margin-left:.5rem;">{{localize "SW5EHELPER.WeaponAttackBonus"}}</span>
    {{/if}}
  </section>

  {{!-- ============== Per-weapon Presets (equal spacing; no Load button) ============== --}}
  <section class="row favorites equal-gap">
    <label for="presetName">{{localize "SW5EHELPER.Preset"}}</label>
    <select name="presetName" id="presetName">
      <option value="">{{localize "SW5EHELPER.None"}}</option>
      {{#each presets}}
        <option value="{{this.name}}" {{#if this.selected}}selected{{/if}}>{{this.name}}</option>
      {{/each}}
    </select>

    <button type="button" class="btn" data-action="save">{{localize "SW5EHELPER.SavePreset"}}</button>
    <button type="button" class="btn warn" data-action="delete">{{localize "SW5EHELPER.DeletePreset"}}</button>
  </section>

  {{!-- ============ Basic Options ============ --}}
  <section class="row group-title">
    <strong>{{localize "SW5EHELPER.BasicOptions"}}</strong>
  </section>

  <section class="row uni1">
    <label for="ability">{{localize "SW5EHELPER.AttackWith"}}</label>
    <select name="ability" id="ability">
      <option value="">{{localize "SW5EHELPER.Default"}}</option>
      {{#each abilities}}
        <option value="{{this}}" {{#if (eq ../ability this)}}selected{{/if}}>{{this}}</option>
      {{/each}}
    </select>

    <label class="chk offhand">
      <input type="checkbox" name="offhand" {{#if offhand}}checked{{/if}}>
      {{localize "SW5EHELPER.OffHand"}}
    </label>
  </section>

  {{!-- ======= Smart Weapon Ability (only when item has smr) ======= --}}
  {{#if showSmart}}
  <section class="row smart">
    <label class="chk">
      <input type="checkbox" name="smart" {{#if smart}}checked{{/if}}>
      {{localize "SW5EHELPER.SmartWeapon"}}
    </label>

    <label for="smartAbility" style="margin-left:.5rem">{{localize "SW5EHELPER.SmartAbility"}}</label>
    <input type="number" id="smartAbility" name="smartAbility" value="{{smartAbility}}" style="width:4.2rem;">
  </section>
  {{/if}}

  {{!-- =========== Weapon Damage (base + bonuses from system.damage.parts) =========== --}}
  <section class="row group-title">
    <strong>{{localize "SW5EHELPER.Damage"}}</strong>
  </section>

  <section class="row base-table">
    <table class="dmg-parts">
      <thead>
        <tr>
          <th>{{localize "SW5EHELPER.Damage"}}</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody>
        {{#each weaponDamageParts}}
          <tr class="{{#if this.isBase}}is-base{{/if}}">
            <td>{{this.formula}}</td>
            <td>{{this.typeLabel}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </section>

  {{!-- =============== Additional Damage (FIXED: prevent collapse) =============== --}}
  <details class="row extras" {{#if extraRows.length}}open{{/if}}>
    <summary>{{localize "SW5EHELPER.ExtraModsDmg"}}</summary>

    <div class="extra-list">
      {{#each extraRows}}
        <div class="extra-row modrow" data-id="{{this.id}}">
          <input type="text" class="mod-formula" name="extra.{{this.id}}.formula" value="{{this.formula}}" placeholder="{{localize 'SW5EHELPER.ExtraModsDmgPH'}}" style="width:10rem;">
          <select class="mod-type" name="extra.{{this.id}}.type">
            {{#each ../damageTypes}}
              <option value="{{this.value}}" {{#if (eq ../this.type this.value)}}selected{{/if}}>{{this.label}}</option>
            {{/each}}
          </select>
          <label class="chk" title="{{localize 'SW5EHELPER.IncludeInCrit'}}">
            <input type="checkbox" class="mod-incrit" name="extra.{{this.id}}.inCrit" {{#if this.inCrit}}checked{{/if}}> {{localize "SW5EHELPER.IncludeInCrit"}}
          </label>
          <button type="button" class="btn warn" data-action="del-row">{{localize "SW5EHELPER.Delete"}}</button>
        </div>
      {{/each}}
    </div>

    <div class="row">
      <button type="button" class="btn" data-action="add-row">{{localize "SW5EHELPER.AddMod"}}</button>
    </div>
  </details>

  {{!-- =============== Global =============== --}}
  <section class="row toggles">
    <label class="chk"><input type="checkbox" name="isCrit" {{#if isCrit}}checked{{/if}}> {{localize "SW5EHELPER.Crit"}}</label>

    {{#if showBrutal}}
      <span class="note brutal" style="margin-left:.75rem;">Brutal: {{brutalXdY}}</span>
    {{/if}}

    <label class="chk" style="margin-left:auto;">
      <input type="checkbox" name="separate" {{#if separate}}checked{{/if}}>
      {{localize "SW5EHELPER.SeparatePerTargetDmg"}}
    </label>
  </section>

  {{!-- ============ Footer (Roll/Cancel) ========== --}}
  <footer class="row footer">
    <button type="button" class="btn primary" data-action="roll">ðŸ’¥ {{localize "SW5EHELPER.Roll"}}</button>
    <button type="button" class="btn cancel" data-action="cancel">{{localize "SW5EHELPER.Cancel"}}</button>
  </footer>

</form>